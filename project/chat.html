<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FamilyTube Chat</title>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&family=Space+Grotesk:wght@500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* â”€â”€ TOKENS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        :root {
            --accent:       #ff5c00;
            --accent-dim:   rgba(255, 92, 0, 0.11);
            --accent-glow:  0 8px 24px rgba(255, 92, 0, 0.32);
            --ink:          #1b1813;
            --muted:        #6d6357;
            --subtle:       #a89d92;
            --paper:        #ffffff;
            --cream:        #f7f1e8;
            --sand:         #f0e9de;
            --stroke:       #e8dfd0;
            --shadow-sm:    0 2px 8px rgba(27,24,19,.06);
            --shadow-md:    0 6px 24px rgba(27,24,19,.10);
            --shadow-lg:    0 20px 48px rgba(27,24,19,.13);
            --bubble-sent:  #ff5c00;
            --bubble-recv:  #ede8e1;
            --online:       #22c55e;
            --offline:      #c7bfb5;
            --r-sm:  8px;
            --r-md:  14px;
            --r-lg:  20px;
            --r-xl:  28px;
        }

        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: "Manrope", system-ui, sans-serif;
            background: var(--cream);
            color: var(--ink);
            height: 100vh;
            overflow: hidden;
        }

        /* â”€â”€ SCROLLBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        ::-webkit-scrollbar            { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track      { background: transparent; }
        ::-webkit-scrollbar-thumb      { background: var(--stroke); border-radius: 99px; }
        ::-webkit-scrollbar-thumb:hover{ background: var(--muted); }

        /* â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        header {
            position: fixed;
            inset: 0 0 auto 0;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 18px;
            gap: 14px;
            background: rgba(255,255,255,0.88);
            backdrop-filter: blur(18px);
            -webkit-backdrop-filter: blur(18px);
            border-bottom: 1px solid var(--stroke);
            z-index: 1000;
        }

        .h-left  { display: flex; align-items: center; gap: 10px; flex-shrink: 0; }
        .h-right { display: flex; align-items: center; gap: 6px;  flex-shrink: 0; }

        .logo {
            display: flex; align-items: center; gap: 7px;
            font-family: "Space Grotesk", sans-serif;
            font-size: 18px; font-weight: 700; letter-spacing: -.3px;
            color: var(--ink); text-decoration: none;
        }
        .logo i { color: var(--accent); font-size: 19px; }

        .icon-btn {
            display: inline-flex; align-items: center; justify-content: center;
            width: 36px; height: 36px; border-radius: 50%;
            border: none; background: transparent;
            color: var(--muted); font-size: 15px;
            cursor: pointer;
            transition: background .18s, color .18s;
            flex-shrink: 0;
        }
        .icon-btn:hover { background: var(--accent-dim); color: var(--accent); }
        .icon-btn:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }

        .header-search {
            flex: 1; max-width: 440px;
            display: flex; align-items: center;
            background: var(--sand); border: 1px solid var(--stroke);
            border-radius: 99px; padding: 0 14px; gap: 8px;
            transition: border-color .2s, box-shadow .2s;
        }
        .header-search:focus-within { border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-dim); }
        .header-search i { color: var(--subtle); font-size: 12px; flex-shrink: 0; }
        .header-search input {
            border: none; background: transparent; outline: none;
            font-family: inherit; font-size: 13px; color: var(--ink); width: 100%;
            padding: 8px 0;
        }
        .header-search input::placeholder { color: var(--subtle); }

        .user-chip {
            display: flex; align-items: center; gap: 8px;
            padding: 3px 4px 3px 10px;
            border-radius: 99px;
            background: var(--sand); border: 1px solid var(--stroke);
        }
        .u-name  { font-size: 13px; font-weight: 700; line-height: 1.2; }
        .u-phone { font-size: 10.5px; color: var(--muted); line-height: 1.2; }
        .user-chip img { width: 28px; height: 28px; border-radius: 50%; object-fit: cover; }

        /* â”€â”€ NAV SIDEBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        nav {
            position: fixed;
            top: 60px; left: 0;
            width: 215px; height: calc(100vh - 60px);
            padding: 10px 8px;
            overflow-y: auto;
            background: rgba(255,255,255,0.85);
            backdrop-filter: blur(14px);
            border-right: 1px solid var(--stroke);
            transition: transform .28s cubic-bezier(.4,0,.2,1);
            z-index: 999;
        }
        nav.closed { transform: translateX(-215px); }

        .nav-item {
            display: flex; align-items: center; gap: 11px;
            padding: 9px 12px; border-radius: var(--r-md);
            text-decoration: none; color: var(--muted);
            font-size: 13.5px; font-weight: 500;
            margin-bottom: 2px;
            transition: background .18s, color .18s, transform .18s;
        }
        .nav-item i { font-size: 15px; width: 18px; text-align: center; flex-shrink: 0; }
        .nav-item:hover  { background: var(--accent-dim); color: var(--accent); transform: translateX(2px); }
        .nav-item.active { background: var(--accent-dim); color: var(--accent); font-weight: 700; }
        .nav-item.danger { color: #e53935; }
        .nav-item.danger:hover { background: rgba(229,57,53,.08); color: #c62828; transform: translateX(2px); }
        .nav-divider { border: none; border-top: 1px solid var(--stroke); margin: 8px 4px; }

        /* â”€â”€ MAIN LAYOUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        main {
            position: fixed;
            top: 60px; left: 215px;
            width: calc(100vw - 215px);
            height: calc(100vh - 60px);
            display: grid;
            grid-template-columns: 275px 1fr 255px;
            gap: 12px;
            padding: 12px 14px 12px 12px;
            overflow: hidden;
            transition: left .28s cubic-bezier(.4,0,.2,1),
                        width .28s cubic-bezier(.4,0,.2,1);
        }
        main.full-width { left: 0; width: 100vw; }

        .panel {
            background: var(--paper);
            border: 1px solid var(--stroke);
            border-radius: var(--r-lg);
            box-shadow: var(--shadow-md);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        /* â”€â”€ PANEL HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .panel-header {
            padding: 14px 14px 10px;
            border-bottom: 1px solid var(--stroke);
            flex-shrink: 0;
        }
        .panel-title {
            font-family: "Space Grotesk", sans-serif;
            font-size: 15px; font-weight: 700; color: var(--ink);
            margin-bottom: 10px;
        }

        /* â”€â”€ CHAT LIST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .search-bar {
            display: flex; align-items: center; gap: 8px;
            background: var(--sand); border: 1px solid transparent;
            border-radius: 99px; padding: 7px 12px;
            transition: border-color .2s, box-shadow .2s;
        }
        .search-bar:focus-within { border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-dim); background: var(--paper); }
        .search-bar i { color: var(--subtle); font-size: 11px; flex-shrink: 0; }
        .search-bar input {
            border: none; background: transparent; outline: none;
            font-family: inherit; font-size: 12.5px; color: var(--ink); width: 100%;
        }
        .search-bar input::placeholder { color: var(--subtle); }

        .chat-items { flex: 1; overflow-y: auto; padding: 6px; }

        .chat-item {
            display: flex; align-items: center; gap: 10px;
            padding: 8px 10px; border-radius: var(--r-md);
            cursor: pointer;
            transition: background .18s;
        }
        .chat-item:hover  { background: var(--cream); }
        .chat-item.active { background: var(--accent-dim); }
        .chat-item.active .ci-name { color: var(--accent); }

        .ci-avatar-wrap { position: relative; flex-shrink: 0; }
        .ci-avatar {
            width: 44px; height: 44px; border-radius: 50%;
            object-fit: cover; display: block;
        }
        .ci-dot {
            position: absolute; bottom: 1px; right: 1px;
            width: 11px; height: 11px; border-radius: 50%;
            background: var(--online); border: 2px solid var(--paper);
        }
        .ci-dot.off { background: var(--offline); }

        .ci-body { flex: 1; min-width: 0; }
        .ci-row { display: flex; justify-content: space-between; align-items: baseline; gap: 6px; }
        .ci-name { font-size: 13px; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .ci-time { font-size: 10px; color: var(--subtle); flex-shrink: 0; }
        .ci-preview {
            font-size: 11.5px; color: var(--muted);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            margin-top: 2px;
        }
        .ci-badge {
            flex-shrink: 0; min-width: 18px; height: 18px;
            background: var(--accent); color: #fff;
            border-radius: 99px; font-size: 10px; font-weight: 700;
            display: flex; align-items: center; justify-content: center;
            padding: 0 5px;
        }

        /* â”€â”€ CHAT MAIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .chat-container { min-height: 0; }

        .chat-header {
            display: flex; align-items: center;
            padding: 11px 14px; gap: 10px;
            border-bottom: 1px solid var(--stroke);
            flex-shrink: 0;
        }

        .back-btn { display: none; }

        .ch-avatar-wrap { position: relative; flex-shrink: 0; }
        .ch-avatar { width: 38px; height: 38px; border-radius: 50%; object-fit: cover; }
        .ch-status-dot {
            position: absolute; bottom: 0; right: 0;
            width: 10px; height: 10px; border-radius: 50%;
            background: var(--online); border: 2px solid var(--paper);
        }

        .ch-info { flex: 1; min-width: 0; }
        .ch-name { font-family: "Space Grotesk", sans-serif; font-size: 14.5px; font-weight: 700; }
        .ch-sub  { font-size: 11px; color: var(--muted); margin-top: 1px; }

        .ch-actions { display: flex; gap: 2px; }

        /* â”€â”€ MESSAGES AREA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .chat-messages {
            flex: 1; overflow-y: auto;
            padding: 14px 18px;
            display: flex; flex-direction: column;
            gap: 2px;
            background: linear-gradient(180deg, rgba(247,241,232,.45) 0%, rgba(255,255,255,0) 55%);
        }

        .day-sep {
            align-self: center;
            font-size: 10.5px; font-weight: 700; letter-spacing: .3px;
            color: var(--muted); background: var(--sand);
            padding: 3px 12px; border-radius: 99px;
            margin: 10px 0;
        }

        /* â”€â”€ MESSAGE ROWS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .msg {
            display: flex; align-items: flex-end; gap: 7px;
            max-width: 72%;
            animation: msgIn .2s ease;
        }
        .msg.sent     { align-self: flex-end; flex-direction: row-reverse; }
        .msg.received { align-self: flex-start; }

        /* Grouping */
        .msg.grp-top .msg-avatar,
        .msg.grp-mid .msg-avatar { visibility: hidden; }
        .msg.grp-end  { margin-bottom: 8px; }

        .msg-avatar {
            width: 28px; height: 28px; border-radius: 50%;
            object-fit: cover; flex-shrink: 0;
        }
        .msg.sent .msg-avatar { display: none; }

        .msg-col { display: flex; flex-direction: column; gap: 1px; max-width: 100%; }

        .msg-sender-name {
            font-size: 10.5px; font-weight: 800;
            margin-bottom: 2px; padding-left: 3px;
        }
        .msg.sent .msg-sender-name { display: none; }

        /* Bubble */
        .msg-bubble {
            padding: 8px 12px;
            border-radius: var(--r-md);
            font-size: 13.5px; line-height: 1.5;
            word-break: break-word;
            display: flex; flex-direction: column; gap: 4px;
        }
        .received .msg-bubble { background: var(--bubble-recv); color: var(--ink); border-bottom-left-radius: 4px; }
        .sent     .msg-bubble { background: var(--bubble-sent); color: #fff;       border-bottom-right-radius: 4px; }

        .msg.grp-top.received .msg-bubble { border-bottom-left-radius: var(--r-md); }
        .msg.grp-mid.received .msg-bubble { border-top-left-radius: 4px; border-bottom-left-radius: 4px; }
        .msg.grp-top.sent     .msg-bubble { border-bottom-right-radius: var(--r-md); }
        .msg.grp-mid.sent     .msg-bubble { border-top-right-radius: 4px; border-bottom-right-radius: 4px; }

        .msg-text { line-height: 1.5; }

        .msg-meta {
            display: flex; align-items: center; justify-content: flex-end;
            gap: 3px; margin-top: 2px;
        }
        .msg-time  { font-size: 10px; color: var(--muted); }
        .sent .msg-time { color: rgba(255,255,255,.65); }
        .msg-check { font-size: 10px; color: rgba(255,255,255,.65); }

        /* Typing indicator */
        .typing-row {
            align-self: flex-start;
            display: none; align-items: flex-end; gap: 7px;
            padding-bottom: 4px;
        }
        .typing-row.show { display: flex; }
        .typing-bubble {
            background: var(--bubble-recv);
            border-radius: var(--r-md) var(--r-md) var(--r-md) 4px;
            padding: 10px 14px; display: flex; gap: 4px; align-items: center;
        }
        .tdot {
            width: 6px; height: 6px; border-radius: 50%;
            background: var(--muted); animation: tPulse 1.3s infinite;
        }
        .tdot:nth-child(2) { animation-delay: .2s; }
        .tdot:nth-child(3) { animation-delay: .4s; }
        @keyframes tPulse {
            0%,60%,100% { transform: translateY(0);   opacity: .45; }
            30%          { transform: translateY(-5px); opacity: 1;   }
        }

        /* Empty state */
        .empty-state {
            display: flex; flex-direction: column; align-items: center;
            justify-content: center; gap: 12px;
            flex: 1; color: var(--muted); text-align: center; padding: 32px;
        }
        .empty-state i { font-size: 52px; color: var(--stroke); }
        .empty-state strong { font-size: 15px; font-weight: 700; color: var(--ink); }
        .empty-state p { font-size: 13px; line-height: 1.6; }

        /* â”€â”€ INPUT BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .chat-input-bar {
            padding: 10px 14px;
            background: var(--paper);
            border-top: 1px solid var(--stroke);
            display: flex; align-items: center; gap: 8px;
            flex-shrink: 0;
        }

        .input-wrapper {
            flex: 1;
            display: flex; align-items: center; gap: 6px;
            background: var(--sand);
            border: 1.5px solid var(--stroke);
            border-radius: var(--r-xl);
            padding: 5px 8px 5px 14px;
            transition: border-color .2s, box-shadow .2s, background .2s;
        }
        .input-wrapper:focus-within {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-dim);
            background: var(--paper);
        }
        #message-input {
            border: none; background: transparent; outline: none;
            font-family: inherit; font-size: 13.5px; color: var(--ink);
            flex: 1; line-height: 1.5;
        }
        #message-input::placeholder { color: var(--subtle); }

        .send-btn {
            width: 38px; height: 38px; border-radius: 50%;
            border: none; background: var(--accent); color: #fff;
            font-size: 14px; cursor: pointer;
            box-shadow: var(--accent-glow);
            transition: transform .18s, box-shadow .18s;
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
        }
        .send-btn:hover  { transform: scale(1.10); box-shadow: 0 10px 30px rgba(255,92,0,.42); }
        .send-btn:active { transform: scale(.93); }

        /* â”€â”€ MEMBERS SIDEBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .members-list { flex: 1; overflow-y: auto; padding: 6px; }

        .member-item {
            display: flex; align-items: center; gap: 10px;
            padding: 7px 10px; border-radius: var(--r-md);
            cursor: pointer;
            transition: background .18s;
        }
        .member-item:hover { background: var(--cream); }

        .m-av-wrap { position: relative; flex-shrink: 0; }
        .m-avatar  { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; display: block; }
        .m-dot {
            position: absolute; bottom: 0; right: 0;
            width: 10px; height: 10px; border-radius: 50%;
            background: var(--online); border: 2px solid var(--paper);
        }
        .m-dot.off { background: var(--offline); }

        .m-info { flex: 1; min-width: 0; }
        .m-name  { font-size: 13px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .m-sub   { font-size: 11px; color: var(--muted); }

        /* â”€â”€ CONNECTION TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        #conn-toast {
            position: fixed; bottom: 22px; left: 50%;
            transform: translateX(-50%) translateY(80px);
            background: #1b1813; color: #fff;
            padding: 7px 16px; border-radius: 99px;
            font-size: 12px; font-weight: 700;
            display: flex; align-items: center; gap: 7px;
            z-index: 2000; box-shadow: var(--shadow-lg);
            transition: transform .3s cubic-bezier(.34,1.56,.64,1);
            pointer-events: none;
        }
        #conn-toast.show { transform: translateX(-50%) translateY(0); }
        .t-dot { width: 7px; height: 7px; border-radius: 50%; background: var(--online); }
        #conn-toast.disc .t-dot { background: #f87171; }

        /* â”€â”€ ANIMATIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        @keyframes msgIn {
            from { opacity: 0; transform: translateY(7px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        /* â”€â”€ RESPONSIVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        @media (max-width: 1160px) {
            main { grid-template-columns: 260px 1fr; }
            .members-panel { display: none; }
        }
        @media (max-width: 960px) {
            .header-search { display: none; }
        }
        @media (max-width: 820px) {
            nav { transform: translateX(-215px); }
            nav.open { transform: translateX(0); }
            main { left: 0 !important; width: 100vw !important; grid-template-columns: 1fr; padding: 8px; }

            .chat-list-panel { display: flex; }
            .chat-container  { display: none; }

            main.mobile-chat .chat-list-panel { display: none; }
            main.mobile-chat .chat-container  { display: flex; }
            .back-btn { display: inline-flex !important; }
        }
    </style>
</head>
<body>

<!-- â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<header>
    <div class="h-left">
        <button class="icon-btn" onclick="toggleSidebar()" aria-label="Toggle sidebar">
            <i class="fas fa-bars"></i>
        </button>
        <a href="/index" class="logo"><i class="fab fa-youtube"></i> FamilyTube</a>
    </div>

    <div class="header-search">
        <i class="fas fa-search"></i>
        <input type="text" placeholder="Search family chatsâ€¦">
    </div>

    <div class="h-right">
        <button class="icon-btn" title="Notifications" aria-label="Notifications">
            <i class="far fa-bell"></i>
        </button>
        <div class="user-chip">
            <div>
                <div class="u-name">{{ username }}</div>
                <div class="u-phone">{{ userph }}</div>
            </div>
            <img src="https://i.pravatar.cc/36?u={{ username }}" alt="{{ username }}">
        </div>
        <button class="icon-btn" onclick="window.location.href='/logout'" title="Logout" aria-label="Logout">
            <i class="fas fa-sign-out-alt"></i>
        </button>
    </div>
</header>

<!-- â”€â”€ NAV SIDEBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<nav id="sidebar">
    <a href="/index" class="nav-item"><i class="fas fa-home"></i> Home</a>
    <a href="#"      class="nav-item"><i class="fas fa-fire"></i> Trending</a>
    <a href="/chat"  class="nav-item active"><i class="fas fa-comment-dots"></i> Chats</a>
    <a href="/videos" class="nav-item"><i class="fas fa-play-circle"></i> Videos</a>
    <a href="#"      class="nav-item"><i class="fas fa-user-friends"></i> Profiles</a>
    <a href="#"      class="nav-item"><i class="fas fa-plane"></i> Trips</a>
    <a href="/status" class="nav-item"><i class="fas fa-history"></i> Status</a>
    <hr class="nav-divider">
    <a href="#"      class="nav-item"><i class="fas fa-cog"></i> Settings</a>
    <a href="/logout" class="nav-item danger"><i class="fas fa-sign-out-alt"></i> Logout</a>
</nav>

<!-- â”€â”€ MAIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<main id="main-content">

    <!-- Chat List -->
    <aside class="panel chat-list-panel">
        <div class="panel-header">
            <h2 class="panel-title">Chats</h2>
            <div class="search-bar">
                <i class="fas fa-search"></i>
                <input id="chat-search-input" type="text" placeholder="Find a chatâ€¦" autocomplete="off">
            </div>
        </div>

        <div class="chat-items" id="chat-items">
            {% for person in chatusers %}
            <div class="chat-item {% if loop.first %}active{% endif %}"
                 data-chat-name="{{ person }}"
                 data-idx="{{ loop.index0 }}"
                 onclick="openChat(this.dataset.chatName, this)"
                 role="button" tabindex="0"
                 aria-label="Open chat with {{ person }}">
                <div class="ci-avatar-wrap">
                    {% if person == 'FamilyChat' %}
                    <img class="ci-avatar" src="https://i.pravatar.cc/44?img=70" alt="FamilyChat">
                    {% else %}
                    <img class="ci-avatar" src="https://i.pravatar.cc/44?u={{ person }}" alt="{{ person }}">
                    {% endif %}
                    <div class="ci-dot {% if loop.index0 > 1 %}off{% endif %}"></div>
                </div>
                <div class="ci-body">
                    <div class="ci-row">
                        <span class="ci-name">{{ person }}</span>
                        <span class="ci-time" id="ci-time-{{ loop.index0 }}"></span>
                    </div>
                    <div class="ci-preview" id="ci-preview-{{ loop.index0 }}">Tap to start chatting</div>
                </div>
                {% if loop.first %}<span class="ci-badge" id="ci-badge-{{ loop.index0 }}">1</span>{% endif %}
            </div>
            {% endfor %}
        </div>
    </aside>

    <!-- Chat Window -->
    <section class="panel chat-container">
        <div class="chat-header">
            <button class="icon-btn back-btn" onclick="backToChats()" aria-label="Back">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="ch-avatar-wrap">
                <img id="chat-avatar" class="ch-avatar" src="https://i.pravatar.cc/38?img=70" alt="Chat avatar">
                <div class="ch-status-dot"></div>
            </div>
            <div class="ch-info">
                <div class="ch-name" id="chat-title">FamilyChat</div>
                <div class="ch-sub"  id="chat-subtitle">{{ chatusers | length }} members</div>
            </div>
            <div class="ch-actions">
                <button class="icon-btn" title="Video call" aria-label="Video call"><i class="fas fa-video"></i></button>
                <button class="icon-btn" title="Voice call" aria-label="Voice call"><i class="fas fa-phone"></i></button>
                <button class="icon-btn" title="More"       aria-label="More options"><i class="fas fa-ellipsis-v"></i></button>
            </div>
        </div>

        <div id="chat-messages" class="chat-messages" role="log" aria-live="polite" aria-label="Messages">
            <!-- Populated by JS -->
        </div>

        <!-- Typing indicator (hidden by default) -->
        <div class="typing-row" id="typing-row">
            <div class="typing-bubble">
                <div class="tdot"></div>
                <div class="tdot"></div>
                <div class="tdot"></div>
            </div>
        </div>

        <div class="chat-input-bar">
            <button class="icon-btn" title="Attach file" aria-label="Attach file">
                <i class="fas fa-paperclip"></i>
            </button>
            <div class="input-wrapper">
                <input id="message-input" type="text" placeholder="Type a messageâ€¦" autocomplete="off" aria-label="Message input">
                <button class="icon-btn" title="Emoji" aria-label="Emoji">
                    <i class="far fa-smile"></i>
                </button>
            </div>
            <button id="send-btn" class="send-btn" aria-label="Send message">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </section>

    <!-- Members Sidebar -->
    <aside class="panel members-panel">
        <div class="panel-header">
            <h2 class="panel-title">Members</h2>
        </div>
        <div class="members-list">
            {% for person in chatusers %}
            <div class="member-item">
                <div class="m-av-wrap">
                    {% if person == 'FamilyChat' %}
                    <img class="m-avatar" src="https://i.pravatar.cc/36?img=70" alt="FamilyChat">
                    {% else %}
                    <img class="m-avatar" src="https://i.pravatar.cc/36?u={{ person }}" alt="{{ person }}">
                    {% endif %}
                    <div class="m-dot {% if loop.index0 > 1 %}off{% endif %}"></div>
                </div>
                <div class="m-info">
                    <div class="m-name">{{ person }}</div>
                    <div class="m-sub">{% if loop.index0 <= 1 %}Online{% else %}Offline{% endif %}</div>
                </div>
            </div>
            {% endfor %}
        </div>
    </aside>
</main>

<!-- Connection Toast -->
<div id="conn-toast">
    <div class="t-dot"></div>
    <span id="conn-text">Connected</span>
</div>

<script>
    /* â”€â”€ UTILS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function escapeHtml(v) {
        return String(v ?? '')
            .replace(/&/g, '&amp;')
            .replace(/</g,  '&lt;')
            .replace(/>/g,  '&gt;');
    }

    function fmtTime(d) {
        return (d instanceof Date ? d : new Date()).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
    }

    const SENDER_COLORS = ['#e05d00','#0077c2','#2ba640','#7c3aed','#c2185b','#0097a7','#d97706'];
    function senderColor(name) {
        let h = 0;
        for (let i = 0; i < name.length; i++) h = (h * 31 + name.charCodeAt(i)) | 0;
        return SENDER_COLORS[Math.abs(h) % SENDER_COLORS.length];
    }

    /* â”€â”€ SIDEBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const main    = document.getElementById('main-content');
        if (window.matchMedia('(max-width: 820px)').matches) {
            sidebar.classList.toggle('open');
        } else {
            sidebar.classList.toggle('closed');
            main.classList.toggle('full-width');
        }
    }

    function backToChats() {
        document.getElementById('main-content').classList.remove('mobile-chat');
    }

    /* â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    const username    = "{{ username }}";
    let selectedChat  = "{{ (chatusers | first) if chatusers else 'FamilyChat' }}";
    let ws;
    let allMessages   = [];

    function normalizeMessage(raw) {
        return {
            message: raw.message ?? '',
            from:    raw.from || raw.username || 'Unknown',
            to:      raw.to   || raw.group    || 'FamilyChat',
            ts:      raw.ts   ? new Date(raw.ts) : new Date()
        };
    }

    function belongsToChat(msg, chat) {
        if (chat === 'FamilyChat') return msg.to === 'FamilyChat';
        return (msg.from === username && msg.to === chat) ||
               (msg.from === chat     && msg.to === username);
    }

    function belongsToSelectedChat(msg) { return belongsToChat(msg, selectedChat); }

    /* â”€â”€ BUILD BUBBLE HTML â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function buildMsgEl(msg, prevMsg, nextMsg) {
        const isMine   = msg.from === username;
        const isGroup  = selectedChat === 'FamilyChat';
        const samePrev = prevMsg && prevMsg.from === msg.from;
        const sameNext = nextMsg && nextMsg.from === msg.from;

        let grpClass = '';
        if (samePrev && sameNext) grpClass = 'grp-mid';
        else if (samePrev)        grpClass = 'grp-end';
        else if (sameNext)        grpClass = 'grp-top';

        const showName   = !isMine && isGroup && !samePrev;
        const showAvatar = !isMine;
        const color      = senderColor(msg.from);
        const avatarSrc  = `https://i.pravatar.cc/28?u=${encodeURIComponent(msg.from)}`;
        const safeText   = escapeHtml(msg.message);
        const safeSender = escapeHtml(msg.from);
        const timeStr    = fmtTime(msg.ts);

        const div = document.createElement('div');
        div.className = `msg ${isMine ? 'sent' : 'received'} ${grpClass}`;
        div.dataset.sender = msg.from;

        div.innerHTML = `
            ${showAvatar ? `<img class="msg-avatar" src="${avatarSrc}" alt="${safeSender}">` : ''}
            <div class="msg-col">
                ${showName ? `<div class="msg-sender-name" style="color:${color}">${safeSender}</div>` : ''}
                <div class="msg-bubble">
                    <div class="msg-text">${safeText}</div>
                    <div class="msg-meta">
                        <span class="msg-time">${timeStr}</span>
                        ${isMine ? '<i class="fas fa-check-double msg-check"></i>' : ''}
                    </div>
                </div>
            </div>`;
        return div;
    }

    /* â”€â”€ RENDER ALL MESSAGES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function renderSelectedChat() {
        const container = document.getElementById('chat-messages');
        container.innerHTML = '';

        const msgs = allMessages.filter(belongsToSelectedChat);

        if (msgs.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="far fa-comment-dots"></i>
                    <strong>No messages yet</strong>
                    <p>Be the first to say hello! ðŸ‘‹</p>
                </div>`;
            return;
        }

        container.insertAdjacentHTML('beforeend', '<div class="day-sep">Today</div>');

        msgs.forEach((msg, i) => {
            container.appendChild(buildMsgEl(msg, msgs[i-1], msgs[i+1]));
        });

        container.scrollTop = container.scrollHeight;
        updatePreviews();
    }

    /* â”€â”€ APPEND SINGLE MESSAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function appendMessage(type, text, timeStr, senderName) {
        const container = document.getElementById('chat-messages');

        // Clear empty state
        const empty = container.querySelector('.empty-state');
        if (empty) {
            container.innerHTML = '<div class="day-sep">Today</div>';
        }

        const isMine  = type === 'sent';
        const isGroup = selectedChat === 'FamilyChat';
        const color   = senderColor(senderName || '');
        const safeSender = escapeHtml(senderName || 'Unknown');
        const safeText   = escapeHtml(text);
        const avatarSrc  = `https://i.pravatar.cc/28?u=${encodeURIComponent(senderName || 'u')}`;

        // Check grouping against last message
        const lastMsg    = container.querySelector('.msg:last-child');
        const lastSender = lastMsg ? lastMsg.dataset.sender : null;
        const sameAsPrev = lastSender === senderName;

        if (sameAsPrev && lastMsg) {
            lastMsg.classList.remove('grp-end');
            lastMsg.classList.add('grp-top');
        }

        const grpClass   = sameAsPrev ? 'grp-end' : '';
        const showName   = !isMine && isGroup && !sameAsPrev;
        const showAvatar = !isMine;

        const div = document.createElement('div');
        div.className = `msg ${type} ${grpClass}`;
        div.dataset.sender = senderName;

        div.innerHTML = `
            ${showAvatar ? `<img class="msg-avatar" src="${avatarSrc}" alt="${safeSender}">` : ''}
            <div class="msg-col">
                ${showName ? `<div class="msg-sender-name" style="color:${color}">${safeSender}</div>` : ''}
                <div class="msg-bubble">
                    <div class="msg-text">${safeText}</div>
                    <div class="msg-meta">
                        <span class="msg-time">${timeStr}</span>
                        ${isMine ? '<i class="fas fa-check-double msg-check"></i>' : ''}
                    </div>
                </div>
            </div>`;

        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
    }

    /* â”€â”€ UPDATE CHAT LIST PREVIEWS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function updatePreviews() {
        document.querySelectorAll('.chat-item').forEach(item => {
            const chatName  = item.dataset.chatName;
            const previewEl = item.querySelector('.ci-preview');
            const timeEl    = item.querySelector('.ci-time');
            if (!previewEl || !chatName) return;

            const msgs = allMessages.filter(m => belongsToChat(m, chatName));
            if (!msgs.length) return;

            const last   = msgs[msgs.length - 1];
            const prefix = last.from === username ? 'You: ' : (selectedChat === 'FamilyChat' ? last.from + ': ' : '');
            const preview = last.message.length > 32 ? last.message.slice(0, 32) + 'â€¦' : last.message;
            previewEl.textContent = prefix + preview;
            if (timeEl) timeEl.textContent = fmtTime(last.ts instanceof Date ? last.ts : new Date());
        });
    }

    /* â”€â”€ OPEN CHAT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function openChat(chatName, el) {
        if (!chatName) return;
        selectedChat = chatName;

        const titleEl  = document.getElementById('chat-title');
        const subEl    = document.getElementById('chat-subtitle');
        const avatarEl = document.getElementById('chat-avatar');

        if (titleEl)  titleEl.textContent  = chatName;
        if (subEl)    subEl.textContent    = chatName === 'FamilyChat' ? '{{ chatusers | length }} members' : 'Online';
        if (avatarEl) avatarEl.src = chatName === 'FamilyChat'
            ? 'https://i.pravatar.cc/38?img=70'
            : `https://i.pravatar.cc/38?u=${encodeURIComponent(chatName)}`;

        document.querySelectorAll('.chat-item').forEach(i => i.classList.remove('active'));
        if (el) el.classList.add('active');

        // Remove badge
        const badge = el ? el.querySelector('.ci-badge') : null;
        if (badge) badge.remove();

        renderSelectedChat();
        document.getElementById('main-content').classList.add('mobile-chat');
        document.getElementById('message-input').focus();
    }

    /* â”€â”€ CONNECTION TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    let toastTimer;
    function showToast(msg, disc = false) {
        const toast = document.getElementById('conn-toast');
        const text  = document.getElementById('conn-text');
        text.textContent = msg;
        toast.classList.toggle('disc', disc);
        toast.classList.add('show');
        clearTimeout(toastTimer);
        if (!disc) toastTimer = setTimeout(() => toast.classList.remove('show'), 2400);
    }

    /* â”€â”€ WEBSOCKET â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function getWsUrl() {
        const scheme = location.protocol === 'https:' ? 'wss' : 'ws';
        return `${scheme}://${location.host}/ws`;
    }

    function connectWebSocket() {
        ws = new WebSocket(getWsUrl());

        ws.onopen = () => showToast('Connected');

        ws.onmessage = (event) => {
            let data;
            try   { data = JSON.parse(event.data); }
            catch { data = { message: String(event.data), from: 'Unknown', to: '', group: '' }; }

            const message = normalizeMessage(data);
            allMessages.push(message);

            if (!belongsToSelectedChat(message)) { updatePreviews(); return; }

            const isMine = message.from === username;
            appendMessage(isMine ? 'sent' : 'received', message.message, fmtTime(new Date()), message.from);
            updatePreviews();
        };

        ws.onclose = (e) => {
            if (e.code === 1000) return;
            showToast('Reconnectingâ€¦', true);
            setTimeout(connectWebSocket, 1500);
        };

        ws.onerror = () => ws.close();
    }

    /* â”€â”€ SEND MESSAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function sendMessage() {
        const input = document.getElementById('message-input');
        const text  = input.value.trim();
        if (!text) return;

        if (!ws || ws.readyState !== WebSocket.OPEN) {
            showToast('Not connected', true); return;
        }

        const payload = { message: text, from: username, to: selectedChat, group: null };
        try { ws.send(JSON.stringify(payload)); }
        catch { return; }

        // Private chats: render locally (group echoed by backend)
        if (selectedChat !== 'FamilyChat') {
            const msg = normalizeMessage(payload);
            allMessages.push(msg);
            appendMessage('sent', msg.message, fmtTime(new Date()), msg.from);
            updatePreviews();
        }

        input.value = '';
    }

    /* â”€â”€ LOAD HISTORY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    async function loadHistory() {
        try {
            const resp = await fetch('/messages');
            if (!resp.ok) return;
            const data = await resp.json();
            if (!Array.isArray(data)) return;
            allMessages = data.map(normalizeMessage);
            renderSelectedChat();
            updatePreviews();
        } catch (e) { console.error('Failed to load messages', e); }
    }

    /* â”€â”€ CHAT SEARCH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    document.getElementById('chat-search-input').addEventListener('input', function () {
        const q = this.value.toLowerCase();
        document.querySelectorAll('.chat-item').forEach(item => {
            const name = (item.dataset.chatName || '').toLowerCase();
            item.style.display = name.includes(q) ? '' : 'none';
        });
    });

    /* â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    window.addEventListener('DOMContentLoaded', async () => {
        const first = document.querySelector('.chat-item[data-chat-name]');
        if (first) {
            selectedChat = first.dataset.chatName || selectedChat;
            const t = document.getElementById('chat-title');
            if (t) t.textContent = selectedChat;
        }

        await loadHistory();
        connectWebSocket();

        document.getElementById('send-btn').addEventListener('click', sendMessage);
        document.getElementById('message-input').addEventListener('keypress', e => {
            if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
        });
    });
</script>
</body>
</html>
